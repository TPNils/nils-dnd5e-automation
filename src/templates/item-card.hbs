<div class="{{@root.staticValues.moduleName}}-item-card"
    data-actor-uuid="{{data.actor.uuid}}"
    {{#if token}}data-token-uuid="{{data.token.uuid}}"{{/if}}
  >

  {{#each data.items as |item itemIndex|}}
    <div data-{{@root.staticValues.moduleName}}-item-index="{{itemIndex}}">
      <div class="{{@root.staticValues.moduleName}}-header">
        <img src="{{item.img}}" title="{{item.name}}" width="36" height="36"/>
        <h3 class="{{@root.staticValues.moduleName}}-item-name">{{item.name}}</h3>
      </div>

      <div class="{{@root.staticValues.moduleName}}-section">
        {{#if item.description}}
          {{{item.description}}}
        {{/if}}
        {{#if item.materials}}
          <p><strong>{{ localize "DND5E.RequiredMaterials" }}.</strong> {{item.materials}}</p>
        {{/if}}
      </div>

      <div class="{{@root.staticValues.moduleName}}-section">
        <div style="display: flex;">
          {{#if item.attack}}
            <div class="{{@root.staticValues.moduleName}}-attack">
              <div class="{{@root.staticValues.moduleName}}-flavor">
                {{#if item.attack.evaluatedRoll}}{{item.attack.mode}}{{else}}&nbsp;{{/if}}
              </div>
              <div class="{{@root.staticValues.moduleName}}-attack-wrapper {{@root.staticValues.moduleName}}-attack-mode-{{item.attack.mode}}">
                {{#if item.attack.evaluatedRoll}}
                  <div>
                    {{> modules/nils-automated-compendium/templates/roll/roll.hbs roll=item.attack.evaluatedRoll}}
                  </div>
                {{else}}
                  <button data-{{@root.staticValues.moduleName}}-action="item-attack">
                    {{#if (eq item.attack.mode 'normal')}}
                      {{#if item.attack.label}}{{item.attack.label}}{{else}}{{localize "DND5E.Attack"}}{{/if}}
                    {{else}}
                      {{item.attack.mode}}
                    {{/if}}
                  </button>
                {{/if}}
                
                <button data-{{@root.staticValues.moduleName}}-action="item-attack-mode-minus" {{#if (eq item.attack.mode 'disadvantage')}}disabled{{/if}}><i class="fas fa-minus"></i></button>
                <button data-{{@root.staticValues.moduleName}}-action="item-attack-mode-plus" {{#if (eq item.attack.mode 'advantage')}}disabled{{/if}}><i class="fas fa-plus"></i></button>
              </div>
            </div>
          {{/if}}
          
          {{#if item.damages.[0]}}
            {{#with item.damages.[0]}}
            <div class="{{@root.staticValues.moduleName}}-first-dmg">
              <div class="{{@root.staticValues.moduleName}}-flavor">
                {{#if this.roll.evaluated}}{{this.displayDamageTypes}}{{else}}&nbsp;{{/if}}
              </div>
              <div>
                {{#if this.roll.evaluated}}
                  {{> modules/nils-automated-compendium/templates/roll/roll.hbs overrideFormula=this.displayFormula roll=this.roll}}
                {{else}}
                  <button data-{{@root.staticValues.moduleName}}-action="item-damage-0">{{#if this.label}}{{this.label}}{{else}}{{localize "DND5E.Damage"}}{{/if}}</button>
                {{/if}}
              </div>
            </div>
            {{/with}}
          {{/if}}
        </div>
        
        {{#each item.damages as |dmg dmgIndex|}}
          {{#if (gt dmgIndex 0)}}
            {{#if dmg.roll.evaluated}}
              {{> modules/nils-automated-compendium/templates/roll/roll.hbs flavor=dmg.displayDamageTypes overrideFormula=dmg.displayFormula roll=dmg.roll}}
            {{else}}
              <button data-{{@root.staticValues.moduleName}}-action="item-damage-{{dmgIndex}}">{{#if dmg.label}}{{dmg.label}}{{else}}{{localize "DND5E.Damage"}}{{/if}}</button>
            {{/if}}
          {{/if}}
        {{/each}}
        
        {{#each item.checks as |check checkIndex|}}
          <button data-{{@root.staticValues.moduleName}}-action="item-check-{{checkIndex}}">
            {{#if check.label}}
            {{dmg.label}}
            {{else if check.save}}
            {{localize "DND5E.SavingThrow"}}
            {{else}}
            Ability check
            {{/if}}
          </button>
        {{/each}}

        {{#if item.template}}
          <button data-{{@root.staticValues.moduleName}}-action="item-template">{{ localize "DND5E.PlaceTemplate" }}</button>
        {{/if}}
      </div>

      <div class="{{@root.staticValues.moduleName}}-footer">
        {{#each item.properties}}
          <span>{{this}}</span>
        {{/each}}
      </div>
    </div>
  {{/each}}
  

  {{#if data.targetAggregate.length}}
    <section class="{{@root.staticValues.moduleName}}-gm-secret">
      <table class="{{@root.staticValues.moduleName}}-targets">
        <thead>
          <tr>
            <th style="width: 30px;"></th>
            <th>Name</th>
            <th style="width: 30px;">HP</th>
            <th style="width: 40px;">Result</th>
          </tr>
        </thead>
        <tbody>
          {{#each data.targetAggregate as |target|}}
            <tr>
              <td>{{#if target.img}}<img src="{{target.img}}" height="20px" width="20px">{{/if}}</td>
              <td>{{target.name}}</td>
              <td>{{target.hpSnapshot.hp}}{{#if target.hpSnapshot.temp}}[{{target.hpSnapshot.temp}}]{{/if}}</td>
              <td>{{target.dmg.calcHp}}{{#if target.hpSnapshot.temp}}{{#if target.dmg.calcTemp}}[{{target.dmg.calcTemp}}]{{/if}}{{/if}}</td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </section>
  {{/if}}
    
</div>
